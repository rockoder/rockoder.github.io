---
interface Props {
  headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

// Filter to only h2 and h3
const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{filteredHeadings.length > 0 && (
  <nav class="text-sm" aria-label="Table of contents">
    <h2 class="font-semibold text-[var(--foreground)] mb-3">On this page</h2>
    <ul class="space-y-2">
      {filteredHeadings.map((heading) => (
        <li
          class:list={[
            heading.depth === 3 && 'ml-4',
          ]}
        >
          <a
            href={`#${heading.slug}`}
            class="block text-[var(--foreground-muted)] hover:text-[var(--accent)] transition-colors toc-link"
            data-slug={heading.slug}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<style>
  .toc-link.active {
    color: var(--accent);
    font-weight: 600;
  }
</style>

<script>
  // Highlight current section in TOC
  const tocLinks = document.querySelectorAll('.toc-link');

  if (tocLinks.length > 0) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const slug = entry.target.id;
          const tocLink = document.querySelector(`.toc-link[data-slug="${slug}"]`);

          if (entry.isIntersecting) {
            // Remove active from all links
            tocLinks.forEach((link) => link.classList.remove('active'));
            // Add active to current link
            tocLink?.classList.add('active');
          }
        });
      },
      {
        rootMargin: '-20% 0% -60% 0%',
        threshold: 0,
      }
    );

    // Observe all headings
    document.querySelectorAll('h2[id], h3[id]').forEach((heading) => {
      observer.observe(heading);
    });
  }
</script>
